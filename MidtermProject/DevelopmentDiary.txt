 
----- 중간프로젝트 개발일지 ----------

08월 20일

1. 환불 규정

2. 결제 수단이 호스트별로 다를 수도 있다

3.예약시 주의사항


08월 21일

4. AJAX 사용시 productNum을 파라미터로 쏴야 한다.(productdetail에서)



**살색 컬러**

 rgba(250, 246, 223, 0.89)




08월 22일


결제 API구동하려면.
자바에서 model을 쏴줘야한다
"kto"란 키로 쏠 거임

그걸 html에서 data-로 받는다

그럼 필요한 정보는?
payDTO 
payNum
 
구매자이메일
구매자폰번호 memberDTO에 있는 정보


날짜 정보 DATECLICK시 어떻게 전송할 것인가도 생각해야함.



-----사용한 라이브러리------
javax.mail


날짜 정보 전송.
시간 정보 전송
java.util.date
java.sql.date

SimpleDateFormat클래스로 처리 완료
예약 insert가능하게 됨



-----------8월 23일-----------

문제 1:
오늘 첫째로 부딪힌 문제는 시작 시간. 종료 시간이 4시간 이하일 경우
4시간 이상 해달라는 얼럿 띄우기

해결: 
select에 아이디 주고
$('#selectEndTime option:selected').val()로 값을 가져올 수 있었음.
단, for문은 돌려야 함

그 후 문자열 일부를 잘라서 조건을 걸었음
조건식에 변수를 넣으면 사업자가 원하는 최소 시간대도 설정 가능


문제 2:
또 풀어야할 건
달력 일정 잠궈두기.

임시 해결: fullcalendar의 validRange로 임시 설정.
오늘 전까지의 날짜가 보이지 않게 되고,
선택하거나 클릭할 수도 없게 되었다.

하지만, 날짜는 보이게 하는 게 시각적으로는 더 보기 좋을 것 같아서(비활성화된 날짜가 회색으로 닫혀있어서 칙칙함)
나중에 다시 해결할 예정 

더 급한 문제가 많아서 보류했다.


문제 3: 동의해야만 결제창 (모달)띄우기
해결 : data-bs-target값 변동시켜서 성공


문제 4: 
결제 긁으면 DB에 적용되는지 테스트
DB에 insert하려면 필요한 값
orderNum 
productNum
아직 다른 부분이 없으니 컨트롤러에서 넣어줄예정

구매자 ID  buy_id로받으면 될듯 
payamount amount로 받아올예정



--------------------8월 24일------------------------------
마침내 결제 insert에는 성공했다.
오늘의 핵심: 환불 관련 DB설정 및 결제완료창 띄우기

문제 1: 환불하기
환불하기를 누르면
기존 결제정보가 뜨면서
환불하시겠냐고 묻는창을 띄워야겠다.

그러려면 결제완료창을 먼저 구현해야겠다는 생각이 들었다.

문제 2 : 결제 완료
결제창에 필요한 결제정보

결제한 사람   member 이름
결제수단  이건 파라미터로 받아야됨
결제금액/시간   총금액/시간   시간은 book 끝시간에서 처음시간 빼기
결제날짜 paydate에 있음

결제 완료하면 마이페이지 결제내역으로 가던가.
그담에 결제내역은 마이페이지에서 ajax으로 따로 띄우는거지






문제3 :
주문번호 따로만들기

해결: 자바에서 랜덤 함수 사용
(실제로 필요한가는 고려해보고 적용해야겠다.)
주문번호 말고 결제번호에만 적용하는건어떤가싶음
api와 관련하여 걸리는 게 없는지 생각해야 할듯

문제 4: 
BOOK테이블의 STATUS가 예약->예약 승인 상태로 바뀌어야 결제되게끔
paycontroller나중에 추가해줘야함

status는 예약만 한건지, 승인까지 된건지 체크용.
payment paystate는 1이면 결제 대기(예약)
2면 결제 완료
3이면 환불이라 가정.

적립금 3%

환불 시 업데이트해야 하는 내용
paystate 




({
          url: "https://api.iamport.kr/payments/cancel",
          method: "post",
          headers: {
            "Content-Type": "application/json",
            "Authorization": access_token // 포트원 서버로부터 발급받은 엑세스 토큰
          },
          data: {
            reason, // 가맹점 클라이언트로부터 받은 환불사유
            imp_uid, // imp_uid를 환불 `unique key`로 입력
            amount: cancel_request_amount, // 가맹점 클라이언트로부터 받은 환불금액
            checksum: cancelableAmount // [권장] 환불 가능 금액 입력
          }
        });

오늘 요약: 결제랑 결제 완료페이지까지 진행 완료. 
URL커넥션을 이용해서 내일 환불을 만들어야겠다

